AWSTemplateFormatVersion: 2010-09-09
Description: >-
  AWS CloudFormation Sample Template AutoScalingMultiAZSample: Create a
  multi-az, load balanced and Auto Scaled sample web site running on an Apache
  Web Server with PHP. The application is configured to span all Availability
  Zones in the region and is Auto-Scaled based on the CPU utilization of the web
  servers. The instances are load balanced with a simple health check against
  the default web page. The web site is available on port 80, however, the
  instances can be configured to listen on any port (8888 by default).
  **WARNING** This template creates one or more Amazon EC2 instances and an
  Elastic Load Balancer. You will be billed for the AWS resources used if you
  create a stack from this template.
Parameters:
 EnumWeb1:
  Description: Aws::Ec2:Instace
  Type: String
  Default: r3.2xlarge
 EnumWeb2:
  Description: Aws::Ec2:Instace
  Type: String
  Default: r3.4xlarge
 EnumWeb3:
  Description: Aws::Ec2:Instace
  Type: String
  Default: r4.2xlarge
 EnumWeb4:
  Description: Aws::Ec2:Instace
  Type: String
  Default: r3.8xlarge
 EnumWeb5:
  Description: Aws::Ec2:Instace
  Type: String
  Default: r4.4xlarge
 EnumWeb6:
  Description: Aws::Ec2:Instace
  Type: String
  Default: r4.8xlarge
 EnumWeb7:
  Description: Aws::Ec2:Instace
  Type: String
  Default: i2.2xlarge
 EnumWeb8:
  Description: Aws::Ec2:Instace
  Type: String
  Default: i2.4xlarge
 EnumWeb9:
  Description: Aws::Ec2:Instace
  Type: String
  Default: i2.8xlarge
 EnumWeb10:
  Description: Aws::Ec2:Instace
  Type: String
  Default: m4.2xlarge
 EnumWeb11:
  Description: Aws::Ec2:Instace
  Type: String
  Default: m4.10xlarge
 EnumWeb12:
  Description: Aws::Ec2:Instace
  Type: String
  Default: m4.16xlarge
 WebServerPort:
  Description: TCP/IP port of the web server.
  Type: Number
  Default: 22
 KeyName: 
  Description: Name of an existing EC2 key pair for SSH access to the EC2 instance.
  Type: "AWS::EC2::KeyPair::KeyName"
 SSHLocation:
   Description: The IP address range that can be used to SSH to the EC2 instances
   Type: String
   MinLength: '9'
   MaxLength: '18'
   Default: 0.0.0.0/16
   AllowedPattern: '(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})'
   ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
Mappings:
  AWSInstanceType2Arch:
    r3.2xlarge:
      Arch: '64'
    r3.4xlarge:
      Arch: '64'
    r3.8xlarge:
      Arch: '64'
    r4.2xlarge:
      Arch: '64'
    r4.4xlarge:
      Arch: '64'
    r4.8xlarge:
      Arch: '64'
    i2.2xlarge:
      Arch: '64'
    i2.4xlarge:
      Arch: '64'
    i2.8xlarge:
      Arch: '64'
    m4.2xlarge:
      Arch: '64'
    m4.4xlarge:
      Arch: '64'
    m4.10xlarge:
      Arch: '64'
    m4.16xlarge:
      Arch: '64'
    m5.2xlarge:
      Arch: '64'
  AWSRegionArch2AMI:
    us-east-1:
      '64':  ami-ec9a6d91
    us-east-2:
      '64': ami-a6c5f2c3
    us-west-1:
      '64': ami-d45a50b4
    us-west-2:
      '64':  ami-dc5ad1a4
    ap-south-1:
      '64': ami-fbb2ed94
    ap-northeast-2:
      '64': ami-e049e48e
    ap-southeast-1:
      '64': ami-872862fb
    ap-southeast-2:
      '64': ami-6164a203
    ap-northeast-1:
      '64': ami-9c4000fa
    ca-central-1:
      '64': ami-959d1af1
    eu-central-1:
      '64': ami-0babc764
    eu-west-1:
      '64': ami-70b5f209
    eu-west-2:
      '64': ami-344ca853
    sa-east-1a:
      '64': ami-ad6e25c1
Resources:
  WebServerGroup:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AvailabilityZones: !GetAZs ''
      LaunchConfigurationName: !Ref LaunchConfig
      MinSize: '1'
      MaxSize: '20'
      LoadBalancerNames:
        - !Ref ElasticLoadBalancer
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2c22c000-1096-429b-93f4-a4f12567f456
  LaunchConfig:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref EnumWeb1
          - Arch
      UserData: !Base64 
        Ref: WebServerPort
      SecurityGroups:
        - !Ref InstanceSecurityGroup
      InstanceType: !Ref EnumWeb1
  WebServerScaleUpPolicy:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerGroup
      Cooldown: '60'
      ScalingAdjustment: '1'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 45b880b5-d60d-4c25-92a4-41eda05bfc8a
  WebServerScaleDownPolicy:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerGroup
      Cooldown: '60'
      ScalingAdjustment: '-1'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 71e8c4ab-c777-43f2-93eb-741d2987421a
  CPUAlarmHigh:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: Scale-up if CPU > 70% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '1'
      Threshold: '90'
      AlarmActions:
        - !Ref WebServerScaleUpPolicy
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebServerGroup
      ComparisonOperator: GreaterThanThreshold
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a08fa081-f4fe-4e1b-9e35-2afacc5046e0
  CPUAlarmLow:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: Scale-down if CPU < 40% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '2'
      Threshold: '70'
      AlarmActions:
        - !Ref WebServerScaleDownPolicy
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebServerGroup
      ComparisonOperator: LessThanThreshold
  WebServerGroup2:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AvailabilityZones: !GetAZs ''
      LaunchConfigurationName: !Ref LaunchConfig2
      MinSize: '1'
      MaxSize: '1'
      LoadBalancerNames:
        - !Ref ElasticLoadBalancer
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2c22c000-1096-429b-93f4-a4f12567f456
  LaunchConfig2:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref EnumWeb2
          - Arch
      UserData: !Base64 
        Ref: WebServerPort
      SecurityGroups:
        - !Ref InstanceSecurityGroup
      InstanceType: !Ref EnumWeb2
  WebServerScaleUpPolicy2:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerGroup2
      Cooldown: '60'
      ScalingAdjustment: '1'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 45b880b5-d60d-4c25-92a4-41eda05bfc8a
  WebServerScaleDownPolicy2:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerGroup2
      Cooldown: '60'
      ScalingAdjustment: '-1'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 71e8c4ab-c777-43f2-93eb-741d2987421a
  CPUAlarmHigh2:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: Scale-up if CPU > 70% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '1'
      Threshold: '70'
      AlarmActions:
        - !Ref WebServerScaleUpPolicy2
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebServerGroup2
      ComparisonOperator: GreaterThanThreshold
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a08fa081-f4fe-4e1b-9e35-2afacc5046e0
  CPUAlarmLow2:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: Scale-down if CPU < 40% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '2'
      Threshold: '40'
      AlarmActions:
        - !Ref WebServerScaleDownPolicy2
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebServerGroup2
      ComparisonOperator: LessThanThreshold
  WebServerGroup3:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AvailabilityZones: !GetAZs ''
      LaunchConfigurationName: !Ref LaunchConfig3
      MinSize: '1'
      MaxSize: '5'
      LoadBalancerNames:
        - !Ref ElasticLoadBalancer
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2c22c000-1096-429b-93f4-a4f12567f456
  LaunchConfig3:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref EnumWeb3
          - Arch
      UserData: !Base64 
        Ref: WebServerPort
      SecurityGroups:
        - !Ref InstanceSecurityGroup
      InstanceType: !Ref EnumWeb3
  WebServerScaleUpPolicy3:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerGroup3
      Cooldown: '60'
      ScalingAdjustment: '1'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 45b880b5-d60d-4c25-92a4-41eda05bfc8a
  WebServerScaleDownPolicy3:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerGroup3
      Cooldown: '60'
      ScalingAdjustment: '-1'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 71e8c4ab-c777-43f2-93eb-741d2987421a
  CPUAlarmHigh3:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: Scale-up if CPU > 70% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '1'
      Threshold: '70'
      AlarmActions:
        - !Ref WebServerScaleUpPolicy3
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebServerGroup3
      ComparisonOperator: GreaterThanThreshold
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a08fa081-f4fe-4e1b-9e35-2afacc5046e0
  CPUAlarmLow3:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: Scale-down if CPU < 40% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '2'
      Threshold: '40'
      AlarmActions:
        - !Ref WebServerScaleDownPolicy3
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebServerGroup3
      ComparisonOperator: LessThanThreshold
  WebServerGroup4:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AvailabilityZones: !GetAZs ''
      LaunchConfigurationName: !Ref LaunchConfig4
      MinSize: '1'
      MaxSize: '1'
      LoadBalancerNames:
        - !Ref ElasticLoadBalancer
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2c22c000-1096-429b-93f4-a4f12567f456
  LaunchConfig4:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref EnumWeb4
          - Arch
      UserData: !Base64 
        Ref: WebServerPort
      SecurityGroups:
        - !Ref InstanceSecurityGroup
      InstanceType: !Ref EnumWeb4
  WebServerScaleUpPolicy7:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerGroup7
      Cooldown: '60'
      ScalingAdjustment: '1'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 45b880b5-d60d-4c25-92a4-41eda05bfc8a
  WebServerScaleDownPolicy7:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerGroup7
      Cooldown: '60'
      ScalingAdjustment: '-1'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 71e8c4ab-c777-43f2-93eb-741d2987421a
  CPUAlarmHigh7:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: Scale-up if CPU > 70% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '1'
      Threshold: '70'
      AlarmActions:
        - !Ref WebServerScaleUpPolicy7
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebServerGroup7
      ComparisonOperator: GreaterThanThreshold
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a08fa081-f4fe-4e1b-9e35-2afacc5046e0
  CPUAlarmLow7:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: Scale-down if CPU < 40% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '2'
      Threshold: '40'
      AlarmActions:
        - !Ref WebServerScaleDownPolicy7
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebServerGroup7
      ComparisonOperator: LessThanThreshold
  WebServerGroup5:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AvailabilityZones: !GetAZs ''
      LaunchConfigurationName: !Ref LaunchConfig5
      MinSize: '1'
      MaxSize: '1'
      LoadBalancerNames:
        - !Ref ElasticLoadBalancer
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2c22c000-1096-429b-93f4-a4f12567f456
  LaunchConfig5:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref EnumWeb5
          - Arch
      UserData: !Base64 
        Ref: WebServerPort
      SecurityGroups:
        - !Ref InstanceSecurityGroup
      InstanceType: !Ref EnumWeb5
  WebServerScaleUpPolicy5:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerGroup5
      Cooldown: '60'
      ScalingAdjustment: '1'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 45b880b5-d60d-4c25-92a4-41eda05bfc8a
  WebServerScaleDownPolicy5:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerGroup5
      Cooldown: '60'
      ScalingAdjustment: '-1'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 71e8c4ab-c777-43f2-93eb-741d2987421a
  CPUAlarmHigh5:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: Scale-up if CPU > 70% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '1'
      Threshold: '70'
      AlarmActions:
        - !Ref WebServerScaleUpPolicy5
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebServerGroup5
      ComparisonOperator: GreaterThanThreshold
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a08fa081-f4fe-4e1b-9e35-2afacc5046e0
  CPUAlarmLow5:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: Scale-down if CPU < 40% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '2'
      Threshold: '40'
      AlarmActions:
        - !Ref WebServerScaleDownPolicy5
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebServerGroup5
      ComparisonOperator: LessThanThreshold
  WebServerGroup6:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AvailabilityZones: !GetAZs ''
      LaunchConfigurationName: !Ref LaunchConfig6
      MinSize: '1'
      MaxSize: '1'
      LoadBalancerNames:
        - !Ref ElasticLoadBalancer
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2c22c000-1096-429b-93f4-a4f12567f456
  LaunchConfig6:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref EnumWeb6
          - Arch
      UserData: !Base64 
        Ref: WebServerPort
      SecurityGroups:
        - !Ref InstanceSecurityGroup
      InstanceType: !Ref EnumWeb6
  WebServerScaleUpPolicy10:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerGroup10
      Cooldown: '60'
      ScalingAdjustment: '1'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 45b880b5-d60d-4c25-92a4-41eda05bfc8a
  WebServerScaleDownPolicy10:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerGroup10
      Cooldown: '60'
      ScalingAdjustment: '-1'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 71e8c4ab-c777-43f2-93eb-741d2987421a
  CPUAlarmHigh10:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: Scale-up if CPU > 70% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '1'
      Threshold: '70'
      AlarmActions:
        - !Ref WebServerScaleUpPolicy10
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebServerGroup10
      ComparisonOperator: GreaterThanThreshold
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a08fa081-f4fe-4e1b-9e35-2afacc5046e0
  CPUAlarmLow10:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: Scale-down if CPU < 40% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '2'
      Threshold: '40'
      AlarmActions:
        - !Ref WebServerScaleDownPolicy10
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebServerGroup10
      ComparisonOperator: LessThanThreshold
  WebServerGroup7:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AvailabilityZones: !GetAZs ''
      LaunchConfigurationName: !Ref LaunchConfig7
      MinSize: '1'
      MaxSize: '5'
      LoadBalancerNames:
        - !Ref ElasticLoadBalancer
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2c22c000-1096-429b-93f4-a4f12567f456
  LaunchConfig7:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref EnumWeb7
          - Arch
      UserData: !Base64 
        Ref: WebServerPort
      SecurityGroups:
        - !Ref InstanceSecurityGroup
      InstanceType: !Ref EnumWeb7
  WebServerGroup8:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AvailabilityZones: !GetAZs ''
      LaunchConfigurationName: !Ref LaunchConfig8
      MinSize: '1'
      MaxSize: '2'
      LoadBalancerNames:
        - !Ref ElasticLoadBalancer
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2c22c000-1096-429b-93f4-a4f12567f456
  LaunchConfig8:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref EnumWeb8
          - Arch
      UserData: !Base64 
        Ref: WebServerPort
      SecurityGroups:
        - !Ref InstanceSecurityGroup
      InstanceType: !Ref EnumWeb8
  WebServerGroup9:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AvailabilityZones: !GetAZs ''
      LaunchConfigurationName: !Ref LaunchConfig9
      MinSize: '1'
      MaxSize: '1'
      LoadBalancerNames:
        - !Ref ElasticLoadBalancer
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2c22c000-1096-429b-93f4-a4f12567f456
  LaunchConfig9:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref EnumWeb9
          - Arch
      UserData: !Base64 
        Ref: WebServerPort
      SecurityGroups:
        - !Ref InstanceSecurityGroup
      InstanceType: !Ref EnumWeb9
  WebServerGroup10:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AvailabilityZones: !GetAZs ''
      LaunchConfigurationName: !Ref LaunchConfig10
      MinSize: '1'
      MaxSize: '3'
      LoadBalancerNames:
        - !Ref ElasticLoadBalancer
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2c22c000-1096-429b-93f4-a4f12567f456
  LaunchConfig10:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref EnumWeb10
          - Arch
      UserData: !Base64 
        Ref: WebServerPort
      SecurityGroups:
        - !Ref InstanceSecurityGroup
      InstanceType: !Ref EnumWeb10
    Metadata:
      'AWS::CloudFormation::Designer':
        id: efd0867f-8b9e-4354-9eb2-613a187e6747
  WebServerScaleUpPolicy10:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerGroup10
      Cooldown: '60'
      ScalingAdjustment: '1'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 45b880b5-d60d-4c25-92a4-41eda05bfc8a
  WebServerScaleDownPolicy10:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerGroup10
      Cooldown: '60'
      ScalingAdjustment: '-1'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 71e8c4ab-c777-43f2-93eb-741d2987421a
  CPUAlarmHigh10:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: Scale-up if CPU > 70% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '1'
      Threshold: '90'
      AlarmActions:
        - !Ref WebServerScaleUpPolicy10
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebServerGroup10
      ComparisonOperator: GreaterThanThreshold
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a08fa081-f4fe-4e1b-9e35-2afacc5046e0
  CPUAlarmLow10:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: Scale-down if CPU < 40% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '1'
      Threshold: '40'
      AlarmActions:
        - !Ref WebServerScaleDownPolicy10
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebServerGroup10
      ComparisonOperator: LessThanThreshold
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 708e7d81-54a6-4ede-a735-9f047b48c649
  WebServerGroup11:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AvailabilityZones: !GetAZs ''
      LaunchConfigurationName: !Ref LaunchConfig11
      MinSize: '1'
      MaxSize: '1'
      LoadBalancerNames:
        - !Ref ElasticLoadBalancer
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2c22c000-1096-429b-93f4-a4f12567f456
  LaunchConfig11:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref EnumWeb11
          - Arch
      UserData: !Base64 
        Ref: WebServerPort
      SecurityGroups:
        - !Ref InstanceSecurityGroup
      InstanceType: !Ref EnumWeb11
    Metadata:
      'AWS::CloudFormation::Designer':
        id: efd0867f-8b9e-4354-9eb2-613a187e6747
  WebServerGroup12:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AvailabilityZones: !GetAZs ''
      LaunchConfigurationName: !Ref LaunchConfig12
      MinSize: '1'
      MaxSize: '1'
      LoadBalancerNames:
        - !Ref ElasticLoadBalancer
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2c22c000-1096-429b-93f4-a4f12567f456
  LaunchConfig12:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref EnumWeb12
          - Arch
      UserData: !Base64 
        Ref: WebServerPort
      SecurityGroups:
        - !Ref InstanceSecurityGroup
      InstanceType: !Ref EnumWeb12
    Metadata:
      'AWS::CloudFormation::Designer':
        id: efd0867f-8b9e-4354-9eb2-613a187e6747
  ElasticLoadBalancer:
    Type: 'AWS::ElasticLoadBalancing::LoadBalancer'
    Properties:
      AvailabilityZones: !GetAZs ''
      Listeners:
        - LoadBalancerPort: '80'
          InstancePort: !Ref WebServerPort
          Protocol: HTTP
      HealthCheck:
        Target: !Join 
          - ''
          - - 'HTTP:'
            - !Ref WebServerPort
            - /
        HealthyThreshold: '3'
        UnhealthyThreshold: '5'
        Interval: '30'
        Timeout: '5'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: e613c62c-df26-40b9-b969-f7274589438d
  InstanceSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Enable SSH access and HTTP from the load balancer only
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: !Ref SSHLocation
        - IpProtocol: tcp
          FromPort: !Ref WebServerPort
          ToPort: !Ref WebServerPort
          SourceSecurityGroupOwnerId: !GetAtt 
            - ElasticLoadBalancer
            - SourceSecurityGroup.OwnerAlias
          SourceSecurityGroupName: !GetAtt 
            - ElasticLoadBalancer
            - SourceSecurityGroup.GroupName
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 84d912bc-c566-4476-9d65-3baf2390e6a1
Outputs:
  URL:
    Description: The URL of the website
    Value: !Join 
      - ''
      - - 'http://'
        - !GetAtt 
          - ElasticLoadBalancer
          - DNSName
Metadata:
  'AWS::CloudFormation::Designer':
    e613c62c-df26-40b9-b969-f7274589438d:
      size:
        width: 60
        height: 60
      position:
        x: 60
        'y': 90
      z: 1
      embeds: []
    84d912bc-c566-4476-9d65-3baf2390e6a1:
      size:
        width: 60
        height: 60
      position:
        x: 180
        'y': 90
      z: 1
      embeds: []
    efd0867f-8b9e-4354-9eb2-613a187e6747:
      size:
        width: 60
        height: 60
      position:
        x: 60
        'y': 210
      z: 1
      embeds: []
      isassociatedwith:
        - 84d912bc-c566-4476-9d65-3baf2390e6a1
    2c22c000-1096-429b-93f4-a4f12567f456:
      size:
        width: 60
        height: 60
      position:
        x: 180
        'y': 210
      z: 1
      embeds: []
      isassociatedwith:
        - efd0867f-8b9e-4354-9eb2-613a187e6747
        - e613c62c-df26-40b9-b969-f7274589438d
    71e8c4ab-c777-43f2-93eb-741d2987421a:
      size:
        width: 60
        height: 60
      position:
        x: 300
        'y': 90
      z: 1
      embeds: []
      isassociatedwith:
        - 2c22c000-1096-429b-93f4-a4f12567f456
    708e7d81-54a6-4ede-a735-9f047b48c649:
      size:
        width: 60
        height: 60
      position:
        x: 300
        'y': 210
      z: 1
      embeds: []
    45b880b5-d60d-4c25-92a4-41eda05bfc8a:
      size:
        width: 60
        height: 60
      position:
        x: 60
        'y': 330
      z: 1
      embeds: []
      isassociatedwith:
        - 2c22c000-1096-429b-93f4-a4f12567f456
    a08fa081-f4fe-4e1b-9e35-2afacc5046e0:
      size:
        width: 60
        height: 60
      position:
        x: 180
        'y': 330
      z: 1
      embeds: []
  EnumWeb1: !And
    - !Equals [!Ref EnumWeb2 ]
    - !Equals [!Ref EnumWeb3 ]
    - !Equals [!Ref EnumWeb4 ]
    - !Equals [!Ref EnumWeb5 ]
    - !Equals [!Ref EnumWeb6 ]
    - !Equals [!Ref EnumWeb7 ]
    - !Equals [!Ref EnumWeb8 ]
    - !Equals [!Ref EnumWeb9 ]
    - !Equals [!Ref EnumWeb10 ]
